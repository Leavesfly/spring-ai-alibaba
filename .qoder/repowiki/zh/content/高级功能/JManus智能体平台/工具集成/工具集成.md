# 工具集成

<cite>
**本文档引用的文件**
- [AbstractBaseTool.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/AbstractBaseTool.java)
- [DatabaseUseTool.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/database/DatabaseUseTool.java)
- [McpRouterProperties.java](file://spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-router/src/main/java/com/alibaba/cloud/ai/mcp/router/config/McpRouterProperties.java)
- [McpGatewayToolManager.java](file://spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-router/src/main/java/com/alibaba/cloud/ai/mcp/gateway/core/McpGatewayToolManager.java)
- [ManusProperties.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/config/ManusProperties.java)
- [McpConnectionFactory.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/mcp/service/McpConnectionFactory.java)
- [CommonToolCallAutoConfiguration.java](file://community/tool-calls/spring-ai-alibaba-starter-tool-calling-common/src/main/java/com/alibaba/cloud/ai/toolcalling/common/CommonToolCallAutoConfiguration.java)
- [JsonParseTool.java](file://community/tool-calls/spring-ai-alibaba-starter-tool-calling-common/src/main/java/com/alibaba/cloud/ai/toolcalling/common/JsonParseTool.java)
- [RestClientTool.java](file://community/tool-calls/spring-ai-alibaba-starter-tool-calling-common/src/main/java/com/alibaba/cloud/ai/toolcalling/common/RestClientTool.java)
- [WebClientTool.java](file://community/tool-calls/spring-ai-alibaba-starter-tool-calling-common/src/main/java/com/alibaba/cloud/ai/toolcalling/common/WebClientTool.java)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)

## 简介
JManus平台提供了一套完整的工具集成解决方案，支持本地工具和远程MCP服务的调用。本平台通过统一的工具注册中心实现运行时发现机制，并实施严格的安全控制策略来确保工具执行的安全性。文档将详细介绍内置工具的使用方法、自定义工具开发教程、性能监控指标以及最佳实践建议。

## 项目结构
JManus平台的工具集成功能主要分布在多个模块中，形成了清晰的分层架构。核心功能由`spring-ai-alibaba-jmanus`模块提供，而MCP相关功能则由独立的`spring-ai-alibaba-mcp`模块管理。

```mermaid
graph TB
subgraph "核心模块"
JManus[spring-ai-alibaba-jmanus]
MCP[spring-ai-alibaba-mcp]
end
subgraph "社区工具"
ToolCalls[community/tool-calls]
DocumentReaders[community/document-readers]
Memories[community/memories]
end
JManus --> MCP
JManus --> ToolCalls
JManus --> DocumentReaders
JManus --> Memories
style JManus fill:#f9f,stroke:#333
style MCP fill:#f9f,stroke:#333
```

**图示来源**
- [spring-ai-alibaba-jmanus](file://spring-ai-alibaba-jmanus)
- [spring-ai-alibaba-mcp](file://spring-ai-alibaba-mcp)

**章节来源**
- [spring-ai-alibaba-jmanus](file://spring-ai-alibaba-jmanus)
- [spring-ai-alibaba-mcp](file://spring-ai-alibaba-mcp)

## 核心组件
JManus平台的工具集成系统由几个关键组件构成：工具基类`AbstractBaseTool`为所有工具提供统一接口；`DatabaseUseTool`实现了数据库操作功能；MCP路由配置`McpRouterProperties`管理远程服务连接；`McpGatewayToolManager`负责网关工具的生命周期管理。

**章节来源**
- [AbstractBaseTool.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/AbstractBaseTool.java)
- [DatabaseUseTool.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/database/DatabaseUseTool.java)
- [McpRouterProperties.java](file://spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-router/src/main/java/com/alibaba/cloud/ai/mcp/router/config/McpRouterProperties.java)
- [McpGatewayToolManager.java](file://spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-router/src/main/java/com/alibaba/cloud/ai/mcp/gateway/core/McpGatewayToolManager.java)

## 架构概述
JManus平台的工具集成架构采用分层设计模式，从上到下分为应用层、服务层、传输层和数据层。这种设计使得本地工具调用与远程MCP服务调用具有相同的抽象接口，同时保持了良好的扩展性和可维护性。

```mermaid
graph TD
A[应用层] --> B[服务层]
B --> C[传输层]
C --> D[数据层]
subgraph A
AA[JManus控制器]
AB[规划引擎]
AC[记忆管理]
end
subgraph B
BA[工具管理器]
BB[MCP路由器]
BC[配置服务]
end
subgraph C
CA[HTTP传输]
CB[WebSocket传输]
CC[文件传输]
end
subgraph D
DA[数据库]
DB[文件系统]
DC[Nacos注册中心]
end
style A fill:#ccf,stroke:#333
style B fill:#cfc,stroke:#333
style C fill:#fcc,stroke:#333
style D fill:#ffc,stroke:#333
```

**图示来源**
- [McpConnectionFactory.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/mcp/service/McpConnectionFactory.java)
- [ManusProperties.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/config/ManusProperties.java)

## 详细组件分析

### 工具基类分析
`AbstractBaseTool`是所有工具实现的基础类，它定义了工具执行的基本契约和上下文管理机制。该类通过泛型参数化输入类型，提供了计划ID管理和直接返回标志等通用功能。

```mermaid
classDiagram
class AbstractBaseTool~I~ {
+String currentPlanId
+String rootPlanId
+boolean isReturnDirect()
+void setCurrentPlanId(String planId)
+void setRootPlanId(String rootPlanId)
+ToolExecuteResult apply(I input, ToolContext toolContext)
+abstract ToolExecuteResult run(I input)
}
class ToolCallBiFunctionDef~I~ {
<<interface>>
+ToolExecuteResult apply(I input, ToolContext toolContext)
+void setCurrentPlanId(String planId)
+void setRootPlanId(String rootPlanId)
+boolean isReturnDirect()
}
AbstractBaseTool~I~ --|> ToolCallBiFunctionDef~I~
```

**图示来源**
- [AbstractBaseTool.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/AbstractBaseTool.java)

**章节来源**
- [AbstractBaseTool.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/AbstractBaseTool.java)

### 数据库工具分析
`DatabaseUseTool`是一个典型的内置工具实现，支持多种数据库操作，包括SQL执行、表结构查询、索引信息获取等。该工具通过`DataSourceService`管理数据源连接，并在执行完成后进行资源清理。

```mermaid
sequenceDiagram
participant AI as AI模型
participant Planner as 规划引擎
participant Tool as DatabaseUseTool
participant Service as DataSourceService
participant DB as 数据库
AI->>Planner : 提出数据库查询请求
Planner->>Tool : 调用execute_sql操作
Tool->>Service : 获取数据源连接
Service->>DB : 建立数据库连接
DB-->>Service : 返回连接对象
Service-->>Tool : 提供数据源服务
Tool->>DB : 执行SQL语句
DB-->>Tool : 返回查询结果
Tool-->>Planner : 返回执行结果
Planner-->>AI : 完成数据库操作
```

**图示来源**
- [DatabaseUseTool.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/database/DatabaseUseTool.java)
- [DataSourceService.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/database/DataSourceService.java)

**章节来源**
- [DatabaseUseTool.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/database/DatabaseUseTool.java)

### MCP服务发现分析
MCP服务发现机制支持多种配置方式，包括Nacos、数据库和文件配置。`McpRouterProperties`中的`discoveryOrder`属性定义了服务发现的优先级顺序，默认使用Nacos作为首选发现方式。

```mermaid
flowchart TD
Start([开始服务发现]) --> CheckOrder["检查discoveryOrder配置"]
CheckOrder --> NacosCheck{"Nacos在顺序中?"}
NacosCheck --> |是| QueryNacos["查询Nacos注册中心"]
NacosCheck --> |否| DbCheck{"数据库在顺序中?"}
QueryNacos --> NacosResult{"找到服务?"}
NacosResult --> |是| ReturnService["返回服务实例"]
NacosResult --> |否| DbCheck
DbCheck --> |是| QueryDb["查询数据库配置"]
DbCheck --> |否| FileCheck{"文件在顺序中?"}
QueryDb --> DbResult{"找到服务?"}
DbResult --> |是| ReturnService
DbResult --> |否| FileCheck
FileCheck --> |是| ReadFile["读取文件配置"]
FileCheck --> |否| NoService["无可用服务"]
ReadFile --> FileResult{"找到服务?"}
FileResult --> |是| ReturnService
FileResult --> |否| NoService
ReturnService --> End([结束])
NoService --> End
```

**图示来源**
- [McpRouterProperties.java](file://spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-router/src/main/java/com/alibaba/cloud/ai/mcp/router/config/McpRouterProperties.java)
- [FileMcpRouterAutoConfiguration.java](file://auto-configurations/spring-ai-alibaba-autoconfigure-mcp-router/src/main/java/com/alibaba/cloud/ai/autoconfigure/mcp/router/FileMcpRouterAutoConfiguration.java)
- [DbMcpRouterAutoConfiguration.java](file://auto-configurations/spring-ai-alibaba-autoconfigure-mcp-router/src/main/java/com/alibaba/cloud/ai/autoconfigure/mcp/router/DbMcpRouterAutoConfiguration.java)

**章节来源**
- [McpRouterProperties.java](file://spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-router/src/main/java/com/alibaba/cloud/ai/mcp/router/config/McpRouterProperties.java)

## 依赖分析
JManus平台的工具集成系统依赖于多个核心模块和服务，这些依赖关系确保了系统的完整性和功能性。

```mermaid
graph LR
JManus --> SpringAI
JManus --> Nacos
JManus --> Database
JManus --> WebClient
JManus --> ObjectMapper
SpringAI --> Core
SpringAI --> AutoConfigure
subgraph "外部依赖"
Nacos
Database[(数据库)]
WebClient
ObjectMapper
end
style JManus fill:#f9f,stroke:#333
style SpringAI fill:#ff9,stroke:#333
style Nacos fill:#9cf,stroke:#333
style Database fill:#cfc,stroke:#333
```

**图示来源**
- [pom.xml](file://spring-ai-alibaba-jmanus/pom.xml)
- [pom.xml](file://spring-ai-alibaba-mcp/pom.xml)

**章节来源**
- [pom.xml](file://spring-ai-alibaba-jmanus/pom.xml)
- [pom.xml](file://spring-ai-alibaba-mcp/pom.xml)

## 性能考虑
JManus平台在工具集成方面实施了多项性能优化措施，以确保高效稳定的运行。

### 连接池配置
平台通过`ManusProperties`中的配置项对MCP服务连接进行精细化控制：

- **最大并发连接数**: 默认值为10，可通过`mcpMaxConcurrentConnections`配置
- **连接超时时间**: 可通过`mcpConnectionTimeoutSeconds`设置
- **最大重试次数**: 默认值为1，可通过`mcpMaxRetryCount`调整

这些配置有助于平衡系统资源利用率和响应性能。

### 缓存机制
平台实现了多级缓存策略：
1. 工具定义缓存
2. 服务发现结果缓存  
3. 数据库连接池缓存
4. 配置属性缓存

缓存机制显著减少了重复计算和网络开销，提高了整体系统性能。

**章节来源**
- [ManusProperties.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/config/ManusProperties.java)
- [McpConnectionFactory.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/mcp/service/McpConnectionFactory.java)

## 故障排查指南
当遇到工具集成相关问题时，可以按照以下步骤进行排查：

### 常见问题及解决方案
1. **工具无法注册**
   - 检查是否正确添加了`@Component`注解
   - 确认Spring容器能够扫描到工具类
   - 验证工具名称的唯一性

2. **MCP服务连接失败**
   - 检查`McpRouterProperties`中的服务配置
   - 验证网络连通性和端口开放情况
   - 查看日志中的具体错误信息

3. **数据库工具执行异常**
   - 确认数据源配置正确
   - 检查数据库连接状态
   - 验证SQL语句的语法正确性

4. **性能瓶颈**
   - 检查连接池配置是否合理
   - 分析慢查询日志
   - 监控系统资源使用情况

**章节来源**
- [DatabaseUseTool.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/tool/database/DatabaseUseTool.java)
- [McpConnectionFactory.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/mcp/service/McpConnectionFactory.java)
- [ManusProperties.java](file://spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/manus/config/ManusProperties.java)

## 结论
JManus平台提供了一个强大而灵活的工具集成框架，支持本地工具和远程MCP服务的无缝集成。通过统一的工具基类设计、灵活的服务发现机制和完善的配置管理，平台能够满足各种复杂场景下的工具调用需求。建议在实际使用中充分利用内置工具，并根据业务需要开发自定义工具，同时注意合理配置性能参数以获得最佳运行效果。